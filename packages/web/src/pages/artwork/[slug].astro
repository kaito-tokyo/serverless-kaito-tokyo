---
import Layout from "../../layouts/Layout.astro";
import fetchApi from "../../lib/strapi.js";
import type { Artwork } from "../../interfaces/Artwork.js";

export async function getStaticPaths() {
  const artworks = await fetchApi<Artwork[]>({
    endpoint: "artworks?populate=*",
    wrappedByKey: "data",
  });

  return artworks.map((artwork) => ({
    params: { slug: artwork.slug },
    props: artwork,
  }));
}
type Props = Artwork;

const artwork = Astro.props;

if (!artwork.SdrImage || !artwork.SdrImage.formats) {
  console.warn(`Artwork ${artwork.slug} has no SdrImage or formats.`);
  throw new Error("Artwork image data is missing.");
}

function getSdrImageSrcset(artwork: Artwork): string {
  if (artwork.SdrImage?.formats == null) {
    console.warn(`Artwork ${artwork.slug} has no SdrImage or formats.`);
    return "";
  }

  const { SdrImage } = artwork;
  const { formats } = SdrImage;

  const allFormats = {
    ...formats,
    original: {
      url: SdrImage.url,
      width: SdrImage.width,
    },
  };

  return Object.values(allFormats)
    .map((format) => `${format.url} ${format.width}w`)
    .join("\n");
}
---

<Layout title={`${artwork.Title} - Kaito.tokyo`}>
  <h1>{artwork.Title} - Kaito.tokyo</h1>
  <section class="artwork-image">
    <figure>
      <figcaption>
        <time datetime={artwork.Date}>{artwork.Date}</time>
        {artwork.Title}
      </figcaption>
      <img
        src={artwork.SdrImage.formats.large.url}
        srcset={getSdrImageSrcset(artwork)}
        sizes="100vw"
        alt={artwork.Title}
        loading="eager"
        decoding="sync"
        width={artwork.SdrImage.width}
        height={artwork.SdrImage.height}
      />
    </figure>
    {/* HdrImage.width is null, so we use SdrImage.width for srcset */}
    {
      artwork.HdrImage && (
        <details>
          <summary>HDR画像を表示</summary>
          <figure>
            <img
              srcset={`${artwork.HdrImage.url} ${artwork.SdrImage.width}w`}
              sizes="100vw"
              alt={artwork.Title}
              loading="lazy"
              decoding="async"
              width={artwork.SdrImage.width}
              height={artwork.SdrImage.height}
            />
          </figure>
        </details>
      )
    }
  </section>
  <hr />
  <a href="/artwork">戻る</a>
</Layout>

<style>
  .artwork-image {
    background: hsla(0, 0%, 98%, 0.9);
    border-radius: 20px;
    padding: 20px 0;
  }

  section {
    max-width: 600px;
    margin: 0 auto;
  }

  figure {
    margin: 0;
  }

  img {
    display: block;
    width: 100%;
    height: auto;
  }

  details summary {
    padding: 12px 16px;
    font-weight: bold;
    cursor: pointer;
  }
</style>
