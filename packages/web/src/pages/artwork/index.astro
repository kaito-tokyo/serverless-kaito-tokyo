---
import "../../styles/global.css";
import fetchApi from "../../lib/strapi.js";
import type { Artwork } from "../../interfaces/Artwork.js";
import { groupByMonth } from "../../lib/group-by-month.js";
import { formatMonthForDisplay } from "../../lib/format-month.js";

const artworks = await fetchApi<Artwork[]>({
  endpoint: "artworks?populate=*&sort=Date:desc",
  wrappedByKey: "data",
});

const groupedArtworks = groupByMonth(artworks);

const monthlyArtworks = Array.from(groupedArtworks.entries())
  .map(([month, artworksInMonth]) => {
    const processedArtworks = artworksInMonth
      .map((artwork) => {
        if (
          !artwork.SdrImage?.url ||
          !artwork.SdrImage.width ||
          !(artwork.SdrImage.width > 0) ||
          !artwork.SdrImage.height ||
          !(artwork.SdrImage.height > 0)
        ) {
          return null;
        }
        return {
          ...artwork,
          displayHeight:
            (200 / artwork.SdrImage.width) * artwork.SdrImage.height,
        };
      })
      .filter(Boolean);

    return {
      formattedMonth: formatMonthForDisplay(month),
      artworks: processedArtworks,
    };
  })
  .filter((group) => group.artworks.length > 0);
---

<!doctype html>
<html lang="ja-JP">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>イラスト - kaito.tokyo</title>
  </head>
  <body>
    <main>
      <h1>イラスト - Kaito.tokyo</h1>
      {
        monthlyArtworks.map(({ formattedMonth, artworks }) => (
          <section>
            <h2>{formattedMonth}</h2>
            <ul>
              {artworks.map((artwork) => (
                <a href={`/artwork/${artwork.slug}`}>
                  <li>
                    <img
                      src={artwork.SdrImage.url}
                      alt={artwork.Title}
                      loading="eager"
                      decoding="sync"
                      width="200"
                      height={artwork.displayHeight}
                    />
                    <p>{artwork.Date}</p>
                    <p>{artwork.Title}</p>
                  </li>
                </a>
              ))}
            </ul>
          </section>
        ))
      }
    </main>
  </body>
</html>

<style>
  ul {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  li {
    width: 200px;
    margin: 0;
    padding: 0;
    background: hsla(0, 0%, 98%, 0.9);
    border-radius: 20px;
    padding: 15px 0;
    border: 2px solid black;
  }
</style>
