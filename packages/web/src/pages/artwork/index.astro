---
import "../../styles/global.css";
import fetchApi from "../../lib/strapi.js";
import type { Artwork } from "../../interfaces/Artwork.js";

const artworks = await fetchApi<Artwork[]>({
  endpoint: "artworks?populate=*&sort=Date:desc",
  wrappedByKey: "data",
});

import { groupByMonth } from "../../lib/group-by-month.js";
const groupedArtworks = groupByMonth(artworks);
---

<!doctype html>
<html lang="ja-JP">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>イラスト - kaito.tokyo</title>
  </head>
  <body>
    <main>
      <h1>イラスト - Kaito.tokyo</h1>
      {
        Object.entries(groupedArtworks).map(([month, artworksInMonth]) => (
          <section>
            <h2>
              {(() => {
                const [year, monthStr] = month.split("-");
                // The month parameter in the Date constructor is zero-based
                const isValidYear = /^\d{4}$/.test(year);
                const isValidMonth =
                  /^\d{1,2}$/.test(monthStr) &&
                  Number(monthStr) >= 1 &&
                  Number(monthStr) <= 12;
                if (isValidYear && isValidMonth) {
                  const dateObj = new Date(Number(year), Number(monthStr) - 1);
                  return dateObj.toLocaleString("ja-JP", {
                    year: "numeric",
                    month: "long",
                  });
                } else {
                  return `${year}-${monthStr}`; // fallback to raw string
                }
              })()}
            </h2>
            <ul>
              {artworksInMonth.map((artwork) => {
                if (
                  !artwork.SdrImage ||
                  !artwork.SdrImage.url ||
                  !artwork.SdrImage.width ||
                  !artwork.SdrImage.height
                ) {
                  return null; // Skip artworks without an image
                }
                return (
                  <a href={`/artwork/${artwork.slug}`}>
                    <li>
                      <img
                        src={artwork.SdrImage.url}
                        alt={artwork.Title}
                        loading="eager"
                        decoding="sync"
                        width="200"
                        height={
                          artwork.SdrImage.width > 0 &&
                          artwork.SdrImage.height > 0
                            ? (200 / artwork.SdrImage.width) *
                              artwork.SdrImage.height
                            : undefined
                        }
                      />
                      <p>{artwork.Date}</p>
                      <p>{artwork.Title}</p>
                    </li>
                  </a>
                );
              })}
            </ul>
          </section>
        ))
      }
    </main>
  </body>
</html>

<style>
  ul {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  li {
    width: 200px;
    margin: 0;
    padding: 0;
    background: hsla(0, 0%, 98%, 0.9);
    border-radius: 20px;
    padding: 15px 0;
    border: 2px solid black;
  }
</style>
