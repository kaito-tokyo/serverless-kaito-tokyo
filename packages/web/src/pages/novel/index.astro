---
import Layout from "../../layouts/Layout.astro";
import fetchApi from "../../lib/strapi.js";
import type { Novel } from "../../interfaces/Novel.js";
import { groupByMonth } from "../../lib/group-by-month.js";
import { formatMonthForDisplay } from "../../lib/format-month.js";
import NovelCard from "../../components/NovelCard.astro";

const novels = await fetchApi<Novel[]>({
  endpoint: "novels?sort=Date:desc",
  wrappedByKey: "data",
});

const groupedNovels = groupByMonth(novels);

const monthlyNovels = Array.from(groupedNovels.entries()).map(
  ([month, novelsInMonth]) => ({
    formattedMonth: formatMonthForDisplay(month),
    novels: novelsInMonth,
  }),
);
---

<Layout title="小説 - kaito.tokyo">
  <h1>小説</h1>
  {
    monthlyNovels.map(({ formattedMonth, novels }) => (
      <section>
        <h2>{formattedMonth}</h2>
        <ul>
          {novels.map((novel) => (
            <NovelCard novel={novel} />
          ))}
        </ul>
      </section>
    ))
  }
</Layout>

<style>
  ul {
    display: flex;
    flex-wrap: wrap;
    margin: 0;
    padding: 0;
    list-style: none;
    gap: 8px;
  }
</style>
