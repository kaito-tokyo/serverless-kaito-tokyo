---
import Layout from "../../layouts/Layout.astro";
import fetchApi from "../../lib/strapi.js";
import type { Novel } from "../../interfaces/Novel.js";
import { groupByMonth } from "../../lib/group-by-month.js";
import { formatMonthForDisplay } from "../../lib/format-month.js";

const novels = await fetchApi<Novel[]>({
  endpoint: "novels?sort=Date:desc",
  wrappedByKey: "data",
});

const groupedNovels = groupByMonth(novels);

const monthlyNovels = Array.from(groupedNovels.entries()).map(
  ([month, novelsInMonth]) => ({
    formattedMonth: formatMonthForDisplay(month),
    novels: novelsInMonth,
  }),
);
---

<Layout title="小説 - kaito.tokyo">
  <h1>小説</h1>
  {
    monthlyNovels.map(({ formattedMonth, novels }) => (
      <section>
        <h2>{formattedMonth}</h2>
        <ul>
          {novels.map((novel) => (
            <li>
                <a href={`/novel/${novel.slug}`}>
                  <p>{novel.Date}</p>
                  <p>{novel.Title}</p>
                </a>
                <p>
                  {novel.Body.split("\n")
                    .filter((line) => !line.startsWith("#"))
                    .join("\n")
                    .substring(0, 100)}...
                </p>
            </li>
          ))}
        </ul>
      </section>
    ))
  }
</Layout>

<style>
  ul {
    display: flex;
    flex-wrap: wrap;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  li {
    width: 200px;
    margin: 0;
    padding: 0;
    background: hsla(0, 0%, 98%, 0.9);
    border-radius: 20px;
    padding: 15px 0;
    border: 2px solid black;
  }
</style>
